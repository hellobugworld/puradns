# PuraDNS配置文件示例
# 这个文件包含了PuraDNS的所有配置选项，包括各种DNS协议支持

# 服务器配置
listen_addr: "127.0.0.1:53"  # 服务器监听地址，127.0.0.1:53表示只在本地监听

# 资源文件配置
# 用来存储国内IP、国内域名和GFW域名列表的文件配置
resource:
  china_ip_path: "/etc/puradns/rules/china-ip.txt"  # 国内IP列表文件路径
  china_list_path: "/etc/puradns/rules/chinalist.txt"  # 国内域名列表文件路径
  gfw_list_path: "/etc/puradns/rules/gfwlist.txt"  # GFW域名列表文件路径
  update_interval: 24h  # 自动更新列表的间隔时间，24h表示每天更新一次
  urls:  # 下载列表文件的URL地址
    china_ip: "https://res.343.re/share/cleardns/china-ip.txt"
    china_list: "https://res.343.re/Share/cleardns/chinaglist.txt"
    gfw_list: "https://res.343.re/Share/cleardns/gfwlist.txt"
  download_timeout: 30s  # 下载列表文件的超时时间
  max_retries: 3  # 下载失败时的最大重试次数
  retry_delay: 5s  # 重试间隔时间

# 缓存配置
# 用来保存之前查询过的DNS结果，加快响应速度
cache:
  enabled: true  # 是否启用缓存（true表示启用）
  capacity: 20000  # 缓存最多能保存20000条DNS记录
  custom_ttl: 30m  # 缓存记录的过期时间，30m表示30分钟
  max_memory: 256MB  # 缓存最多使用256MB内存

# 预刷新配置
# 在DNS记录过期前自动刷新，避免用户请求时等待
pre_refresh:
  enabled: true  # 是否启用预刷新（true表示启用）
  threshold: 0.2  # 当记录剩余生命周期不足20%时开始刷新
  interval: 15m  # 检查需要刷新的记录的时间间隔
  max_concurrency: 10  # 同时最多刷新10条记录
  retry_count: 3  # 刷新失败时的重试次数

# 上游DNS配置
# 配置用来查询的上级DNS服务器
upstream:
  # 引导DNS服务器
  # 用来解析加密DNS服务器（DoT/DoH）的域名
  bootstrap: ["223.5.5.5:53", "119.29.29.29:53"]  # 使用国内公共DNS作为引导
  
  # 国内DNS服务器配置
  domestic:
    # 国内DNS - 使用加密的DoT协议
    - addr: "dns.alidns.com:853"
      protocol: "dot"  # dot表示DNS over TLS（加密）
      tls_config:
        server_name: "dns.alidns.com"  # 服务器名称，用于TLS验证
    
    # 国内DNS - 使用DoH协议（HTTP/2）
    - addr: "https://doh.pub/dns-query"
      protocol: "doh"  # doh表示DNS over HTTPS（加密）
      http3: false  # 不使用HTTP/3，只使用HTTP/2
      tls_config:
        server_name: "doh.pub"  # 服务器名称，用于TLS验证
    
    # 国内DNS - 使用DoH协议（支持HTTP/3）
    - addr: "https://dns.alidns.com/dns-query"
      protocol: "doh"  # doh表示DNS over HTTPS（加密）
      http3: true  # 优先使用HTTP/3，失败时自动回退到HTTP/2
      tls_config:
        server_name: "dns.alidns.com"  # 服务器名称，用于TLS验证
  
  # 国外DNS服务器配置
  foreign:
    # 国外DNS - 使用加密的DoT协议
    - addr: "8.8.8.8:853"
      protocol: "dot"  # dot表示DNS over TLS（加密）
      tls_config:
        server_name: "dns.google"  # 服务器名称，用于TLS验证
    
    # 国外DNS - 使用DoH协议（HTTP/2）
    - addr: "https://cloudflare-dns.com/dns-query"
      protocol: "doh"  # doh表示DNS over HTTPS（加密）
      http3: false  # 不使用HTTP/3，只使用HTTP/2
      # tls_config是可选的，当不需要自定义TLS配置时可以省略
      tls_config:
        server_name: "cloudflare-dns.com"  # 服务器名称，用于TLS验证
    
    # 国外DNS - 使用DoH协议（支持HTTP/3）
    - addr: "https://dns.cloudflare.com/dns-query"
      protocol: "doh"  # doh表示DNS over HTTPS（加密）
      http3: true  # 优先使用HTTP/3，失败时自动回退到HTTP/2
      tls_config:
        server_name: "dns.cloudflare.com"  # 服务器名称，用于TLS验证
  
  # 查询超时时间
  query_timeout: 5s  # 向上游DNS查询的超时时间，5秒没响应就算失败
  # 健康检查间隔时间
  health_check: 1h  # 每隔1小时检查一次上游DNS服务器是否可用

# 安全配置
# 用来保护DNS服务器的安全设置
security:
  max_queries_per_second: 1000  # 每秒最多处理1000个查询，防止DNS洪水攻击
  max_response_size: 4096  # DNS响应的最大大小，防止过大的响应包
  enable_dnssec: true  # 是否启用DNSSEC验证（true表示启用，验证DNS记录的真实性）
  enable_query_logging: true  # 是否记录DNS查询日志（true表示记录）
  restricted_query_types: [255]  # 禁止查询ANY类型记录，255就是ANY类型的代码

# Goroutine池配置
# 用来控制DNS服务器同时处理多少请求，避免服务器因请求过多而崩溃
goroutinepool:
  size: 150        # 同时能处理请求的"工人"数量（最多150个请求同时处理）
  queue_size: 1500  # 当"工人"都在忙时，排队等待的请求数量（最多1500个请求排队）
